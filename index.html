<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>NOFX Days of Christmas</title>

  <!-- Favicon -->
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="Assets/favicon_io/apple-touch-icon.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="Assets/favicon_io/favicon-32x32.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="Assets/favicon_io/favicon-16x16.png"
  />
  <link
    rel="icon"
    href="Assets/favicon_io/favicon.ico"
  />
  <link
    rel="manifest"
    href="Assets/favicon_io/site.webmanifest"
  />

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

.day.opened img.cover {
  object-fit: cover;
  aspect-ratio: 1 / 1;
}

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #ffefef, #fff5f0);
      padding: 20px 10px 60px;
      display: flex;
      justify-content: center;
      position: relative;
    }

    .wrapper {
      text-align: center;
      width: 100%;
      max-width: 600px;
      position: relative;
      z-index: 2; /* above snow */
    }

    .heading-logo {
      width: 175px;
      max-width: 60%;
      margin-bottom: 24px;
      filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.35));
    }

    .tree-container {
      display: inline-block;
    }

    .calendar,
    .trunk {
      position: relative;
      z-index: 2;
    }

    .calendar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .row {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .trunk {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    /* Gift-style doors */
    .day {
      position: relative;
      width: 90px;
      height: 90px;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;

      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.22);
      background: #2e8b57;
      background-image: linear-gradient(
        145deg,
        rgba(255, 255, 255, 0.12),
        transparent 40%,
        rgba(0, 0, 0, 0.25)
      );
      border: 1px solid rgba(0, 0, 0, 0.25);

      transition: transform 0.2s ease, box-shadow 0.2s ease,
        filter 0.2s ease;
      overflow: hidden;
    }

    .day:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.28);
      filter: brightness(1.05);
    }

    /* trunk colour */
    .trunk .day {
      background-color: #3d251a;
      background-image: none;
    }

    .trunk .day:hover {
      filter: brightness(1.08);
    }

    /* Opened gift door */
    .day.opened {
      color: transparent;
      border: 2px solid #c8a34b;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .day img.cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* door number badge */
    .door-number {
      position: relative;
      z-index: 1;
    }

    .day.opened .door-number {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.96);
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid #000000;
      color: #000000;
      font-size: 1rem;
      font-weight: bold;
    }

    /* star tile (24) */
    .day.star {
      background-color: #ffe8a0;
      background-image: none;
      border: 2px solid #ffcc00;
      box-shadow: 0 5px 12px rgba(255, 204, 0, 0.5);
      clip-path: polygon(
        50% 0%,
        61% 35%,
        98% 35%,
        68% 57%,
        79% 91%,
        50% 70%,
        21% 91%,
        32% 57%,
        2% 35%,
        39% 35%
      );
    }

    .day.star.opened {
      clip-path: inherit;
      overflow: hidden;
    }

    .day.star.opened img.cover {
      clip-path: inherit;
    }

    /* opening animation */
    .day.opening {
      animation: popOpen 0.25s ease-out;
    }
#shareIcon {
  width: 32px;
  height: 32px;
  cursor: pointer;
  border-radius: 50%;
  background: #ffffff;
  padding: 4px;
  box-shadow: 0 0 6px rgba(0,0,0,0.25);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

#shareIcon:hover {
  transform: translateY(-1px) scale(1.05);
  box-shadow: 0 0 8px rgba(0,0,0,0.35);
}
    
    @keyframes popOpen {
      0% {
        transform: scale(0.92);
      }
      70% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    /* locked shake animation */
    .day.locked-shake {
      animation: shake 0.3s ease;
    }

    @keyframes shake {
      0% {
        transform: translateX(0);
      }
      25% {
        transform: translateX(-4px);
      }
      50% {
        transform: translateX(4px);
      }
      75% {
        transform: translateX(-4px);
      }
      100% {
        transform: translateX(0);
      }
    }

    /* Modal */
    #albumModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 999;
    }

    #albumContent {
      background: #fff0f0;
      border-radius: 14px;
      padding: 18px 16px 16px;
      max-width: 320px;
      width: 100%;
      text-align: center;
      border: 2px solid #d70000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #albumCover {
      max-width: 210px;
      max-height: 210px;
      border-radius: 8px;
      display: block;
      margin: 4px auto 14px;
      border: 2px solid rgba(0, 0, 0, 0.28);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
    }

    #albumTitle {
      margin: 4px 0 2px;
      font-size: 1.05rem;
      font-weight: bold;
      color: #b00000;
    }

    #albumYear {
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: #444444;
    }

    .modal-close-btn {
      margin-top: 4px;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #d70000;
      color: #ffffff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .modal-close-btn:hover {
      background: #ff1a1a;
    }

    /* Spotify & Genius icons + menus */
    #albumLinks {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 8px 0 10px;
      align-items: center;
    }

    .icon-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .album-icon {
      width: 32px;
      height: 32px;
      cursor: pointer;
      border-radius: 50%;
      background: #ffffff;
      padding: 4px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .album-icon:hover {
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
    }

    .album-icon.disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    .link-menu {
      position: absolute;
      top: 42px; /* just under the icon */
      left: 50%;
      transform: translateX(-50%);
      min-width: 180px;
      background: #fffdf8;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
      padding: 6px 0;
      z-index: 1000;
      display: none;
    }

    .link-menu.open {
      display: block;
      animation: menuFadeIn 0.12s ease-out;
    }

    .link-menu button {
      width: 100%;
      padding: 6px 10px;
      border: none;
      background: transparent;
      text-align: left;
      font-size: 0.85rem;
      cursor: pointer;
      color: #3a1212;
      display: block;
      white-space: nowrap;
    }

    .link-menu button:hover {
      background: #ffe9c7;
    }

    @keyframes menuFadeIn {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(-4px);
      }
      100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Surprise Gift button (25th) */
    #surpriseGiftBtn {
      margin-top: 20px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #c8a34b;
      background: #ffffff;
      color: #5a0f1c;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      display: none; /* shown conditionally via JS */
      gap: 6px;
      align-items: center;
      justify-content: center;
    }

    #surpriseGiftBtn span.icon {
      font-size: 1.1rem;
    }

    #surpriseGiftBtn:hover {
      background: #fff8ea;
      box-shadow: 0 0 8px rgba(200, 163, 75, 0.5);
    }

    /* Snowflakes behind tree */
    .snowflake {
      position: fixed;
      top: -10px;
      color: #ffffff;
      font-size: 1em;
      user-select: none;
      pointer-events: none;
      z-index: 0;
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    @keyframes fall {
      0% {
        transform: translateY(0) rotate(0deg);
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">

    <!-- Header Logo -->
    <img
      class="heading-logo"
      src="Assets/NOFX.jpg"
      alt="NOFX Logo"
    />

    <!-- Christmas Tree Calendar -->
    <div class="tree-container">
      <div class="calendar" id="calendar"></div>
      <div class="trunk" id="trunk"></div>
    </div>

    <!-- Surprise Gift (25th) -->
    <button id="surpriseGiftBtn">
      <span class="icon">üéÅ</span>
      <span>Surprise Gift</span>
    </button>

  </div>

  <!-- Modal Popup -->
  <div id="albumModal">
    <div id="albumContent">

      <img id="albumCover" alt="Album cover" />
      <h3 id="albumTitle"></h3>
      <div id="albumYear"></div>

      <!-- Spotify + Genius Icons -->
      <div id="albumLinks">

        <div class="icon-wrapper">
          <img
            id="spotifyIcon"
            class="album-icon"
            src="Assets/spotify-icon.png"
            alt="Spotify"
          />
          <div id="spotifyMenu" class="link-menu"></div>
        </div>

        <div class="icon-wrapper">
          <img
            id="geniusIcon"
            class="album-icon"
            src="Assets/genius-logo.png"
            alt="Genius"
          />
          <div id="geniusMenu" class="link-menu"></div>
        </div>
<div class="icon-wrapper">
  <img
    id="shareIcon"
    class="album-icon"
    src="Assets/share-icon.png"
    alt="Share"
  />
</div>

      </div>

      <!-- Close -->
      <button class="modal-close-btn" onclick="closeModal()">
        Close
      </button>

    </div>
  </div>
  <script>
/* ------------- ALBUM DATA ------------- */
const albums = [
  { title: "Liberal Animation", year: 1988, cover: "Assets/liberal-animation.jpg",
    spotify: "https://open.spotify.com/album/2GCHIqzroqpjQwszmUdk5F",
    genius: "https://genius.com/albums/Nofx/Liberal-animation"
  },
  { title: "S&M Airlines", year: 1989, cover: "Assets/s-and-m-airlines.jpg",
    spotify: "https://open.spotify.com/album/4vM1w3hbxQHcNghS0wg1dF",
    genius: "https://genius.com/albums/Nofx/S-m-airlines"
  },
  { title: "Ribbed", year: 1991, cover: "Assets/ribbed.jpg",
    spotify: "https://open.spotify.com/album/6xyLnMyql9hJdI65dyJNif",
    genius: "https://genius.com/albums/Nofx/Ribbed"
  },
  { title: "White Trash, Two Heebs and a Bean", year: 1992, cover: "Assets/white-trash-two-heebs-and-a-bean.jpg",
    spotify: "https://open.spotify.com/album/5dbWoqjHDExyrEJD9ftnay",
    genius: "https://genius.com/albums/Nofx/White-trash-two-heebs-and-a-bean"
  },
  { title: "Punk in Drublic", year: 1994, cover: "Assets/punk-in-drublic.jpg",
    spotify: "https://open.spotify.com/album/6Z8BYH27wINoUk4QMUx7gh",
    genius: "https://genius.com/albums/Nofx/Punk-in-drublic"
  },
  { title: "Heavy Petting Zoo", year: 1996, cover: "Assets/heavy-petting-zoo.jpg",
    spotify: "https://open.spotify.com/album/5SoeTpVu2MFq5RlCsdRBf2",
    genius: "https://genius.com/albums/Nofx/Heavy-petting-zoo"
  },
  { title: "So Long and Thanks for All the Shoes", year: 1997, cover: "Assets/so-long-and-thanks-for-all-the-shoes.jpg",
    spotify: "https://open.spotify.com/album/1EaixZGxjvdZIsRiyMBZDb",
    genius: "https://genius.com/albums/Nofx/So-long-and-thanks-for-all-the-shoes"
  },
  { title: "Pump Up the Valuum", year: 2000, cover: "Assets/pump-up-the-valuum.jpg",
    spotify: "https://open.spotify.com/album/37hvw6OVfRLktCmFcU9zHE",
    genius: "https://genius.com/albums/Nofx/Pump-up-the-valuum"
  },
  { title: "The War on Errorism", year: 2003, cover: "Assets/the-war-on-errorism.jpg",
    spotify: "https://open.spotify.com/album/0D6YPfv9u2JHdp1kiieR25",
    genius: "https://genius.com/albums/Nofx/The-war-on-errorism"
  },
  { title: "Wolves in Wolves' Clothing", year: 2006, cover: "Assets/wolves-in-wolves-clothing.jpg",
    spotify: "https://open.spotify.com/album/0bb9iLMHdUJhFIVwOars3P",
    genius: "https://genius.com/albums/Nofx/Wolves-in-wolves-clothing"
  },
  { title: "Coaster", year: 2009, cover: "Assets/coaster.jpg",
    spotify: "https://open.spotify.com/album/5l2QTQ0OoyQw9luosyCe9X",
    genius: "https://genius.com/albums/Nofx/Coaster"
  },
  { title: "Self Entitled", year: 2012, cover: "Assets/self-entitled.jpg",
    spotify: "https://open.spotify.com/album/3yLkOvGA3vHtwEyqMcnp18",
    genius: "https://genius.com/albums/Nofx/Self-entitled"
  },
  { title: "First Ditch Effort", year: 2016, cover: "Assets/first-ditch-effort.jpg",
    spotify: "https://open.spotify.com/album/2WJFIzmyJ6Egq00seat7hy",
    genius: "https://genius.com/albums/Nofx/First-ditch-effort"
  },
  { title: "Single Album", year: 2021, cover: "Assets/single-album.jpg",
    spotify: "https://open.spotify.com/album/7clMEugC4qJ1ApbscpXsaL",
    genius: "https://genius.com/albums/Nofx/Single-album"
  },
  { title: "Double Album", year: 2022, cover: "Assets/double-album.jpg",
    spotify: "https://open.spotify.com/album/4mJ4PBk5yHl3xuyHkly85n",
    genius: "https://genius.com/albums/Nofx/Double-album"
  },
  { title: "Half Album", year: 2023, cover: "Assets/half-album.jpg",
    spotify: "https://open.spotify.com/album/6TabKLBAyynahNuuxaKGOD",
    genius: "https://genius.com/albums/Nofx/Half-album"
  },

  { title: "The Longest EP", year: 2010, cover: "Assets/the-longest-ep.jpg",
    spotify: "https://open.spotify.com/album/2PxPjYo7QT9Utmz0seSLjW",
    genius: "https://genius.com/albums/Nofx/The-longest-ep"
  },
  { title: "Stoke Extinguisher", year: 2013, cover: "Assets/stoke-extinguisher.jpg",
    spotify: "https://open.spotify.com/album/0SS7CfFFNUNdpAgL3NRma7",
    genius:  "https://genius.com/albums/Nofx/Stoke-extinguisher"
  },

  { title: "Maximum RocknRoll", year: 1984, cover: "Assets/maximum-rocknroll.jpg",
    spotify: "https://open.spotify.com/album/5iGh6l7JnaIfw7x1Tz4mnj",
    genius: "https://genius.com/albums/Nofx/The-album"
  },
  { title: "45 or 46 Songs‚Ä¶", year: 2002, cover: "Assets/45-or-46-songs.jpg",
    spotify: "https://open.spotify.com/album/4uVWzS36kkWNFOXUjSym8g",
    genius: "https://genius.com/albums/Nofx/45-or-46-songs-that-werent-good-enough-to-go-on-our-other-records"
  },

  { title: "Backstage Passport Soundtrack", year: 2008, cover: "Assets/backstage-passport.jpg",
    spotify: "https://open.spotify.com/album/0eQbe8kRqqeQ9c1ePfd2QW",
    genius: "https://genius.com/albums/Nofx/Backstage-passport-soundtrack"
  },

  /* ---- COMBINED LIVE DOOR ---- */
  {
    title: "They Suck Live",
    year: null,
    cover: "Assets/they-suck-live.png",
    spotifyMenu: [
      { name: "I Heard They Suck Live!!", url: "https://open.spotify.com/album/1mV82C6196W7GvOS8yoAeM" },
      { name: "They've Actually Gotten Worse Live!", url: "https://open.spotify.com/album/49Xhg2MpQBNbMqr1FGdFdX" }
    ],
    geniusMenu: [
      { name: "I Heard They Suck Live!!", url: "https://genius.com/albums/Nofx/I-heard-they-suck-live" },
     { name: "They‚Äôve Actually Gotten Worse Live!", url: "https://genius.com/albums/Nofx/Theyve-actually-gotten-worse-live" }
    ]
  },

  /* ---- COMBINED SPLITS DOOR ---- */
 {
  title: "The Splits",
  year: null,
  cover: "Assets/the-splits.jpg",
  spotifyMenu: [
    { 
      name: "West Coast vs Wessex", 
      url: "https://open.spotify.com/album/1V0jqCyz5StIhGp16Ggdz7" 
    },
    { 
      name: "BYO Split Series Vol.3 (NOFX/Rancid)", 
      url: "https://open.spotify.com/playlist/54l8ejeS0JXxKkkBNc7dpW" 
    }
  ],
  geniusMenu: [
    { 
      name: "West Coast vs Wessex", 
      url: "https://genius.com/albums/Nofx/West-coast-vs-wessex" 
    },
    { 
      name: "BYO Split Series Vol.3 (NOFX/Rancid)", 
      url: "https://genius.com/albums/Nofx/Byo-split-series-volume-iii" 
    }
  ]
},


  { title: "The Decline", year: 1999, cover: "Assets/the-decline.jpg",
    spotify: "https://open.spotify.com/album/0LW2FwC8ay4hXNDzaw7jWY",
    genius: "https://genius.com/Nofx-the-decline-lyrics"
  }
];
/* -------- TREE LAYOUT CONSTANTS -------- */
const STAR_ROWS = 1;
const bodyRowStructure = [1, 2, 3, 4, 5, 6]; // 21 doors
const trunkHeight = 2; // 2 doors
const POSITIONS_COUNT =
  STAR_ROWS +
  bodyRowStructure.reduce((a, b) => a + b, 0) +
  trunkHeight; // total 24

/* -------- DOOR COLOURS -------- */
const doorColors = [
  "#0c3b2e", // deep green
  "#9c1b1b", // warm red
  "#c8a34b", // muted gold
  "#295b42", // pine green
  "#5a0f1c"  // burgundy
];

/* -------- LOCALSTORAGE KEYS -------- */
const STORAGE_PREFIX = "nofx_tree_v13_";
const KEY_ALBUMS = STORAGE_PREFIX + "albums";
const KEY_DOOR_NUMBERS = STORAGE_PREFIX + "doors";
const KEY_OPENED = STORAGE_PREFIX + "opened";
const KEY_COLORS = STORAGE_PREFIX + "colors";
const KEY_OVERRIDE = STORAGE_PREFIX + "override";

/* -------- UTILS -------- */
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function load(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw);
  } catch {
    return fallback;
  }
}

function save(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

/* -------- NZ DATE -------- */
function getNzDay() {
  return parseInt(
    new Intl.DateTimeFormat("en-NZ", {
      timeZone: "Pacific/Auckland",
      day: "numeric"
    }).format(new Date()),
    10
  );
}

function getNzMonth() {
  return parseInt(
    new Intl.DateTimeFormat("en-NZ", {
      timeZone: "Pacific/Auckland",
      month: "numeric"
    }).format(new Date()),
    10
  );
}

const todayNzDay = getNzDay();
const todayNzMonth = getNzMonth();

/* -------- ADMIN OVERRIDE -------- */
let adminOverride = !!load(KEY_OVERRIDE, false);

/* -------- RANDOMISE ALBUMS (PERSIST) -------- */
let shuffledAlbums = load(KEY_ALBUMS, null);
if (!shuffledAlbums || shuffledAlbums.length !== albums.length) {
  shuffledAlbums = shuffle([...albums]);
  save(KEY_ALBUMS, shuffledAlbums);
}

/* -------- ASSIGN DOOR NUMBERS -------- */
let doorNumbers = load(KEY_DOOR_NUMBERS, null);

if (
  !doorNumbers ||
  doorNumbers.length !== POSITIONS_COUNT ||
  doorNumbers[0] !== 24
) {
  const rest = shuffle(Array.from({ length: 23 }, (_, i) => i + 1)); // 1..23
  doorNumbers = [24, ...rest];
  save(KEY_DOOR_NUMBERS, doorNumbers);
}

/* -------- OPENED STATE -------- */
let opened = load(KEY_OPENED, {});

/* -------- RANDOM COLOURS -------- */
let colorMap = load(KEY_COLORS, null);
if (!colorMap || colorMap.length !== POSITIONS_COUNT) {
  colorMap = Array.from(
    { length: POSITIONS_COUNT },
    () => Math.floor(Math.random() * doorColors.length)
  );
  save(KEY_COLORS, colorMap);
}

/* -------- ELEMENT REFS -------- */
const calendarEl = document.getElementById("calendar");
const trunkEl = document.getElementById("trunk");
const doorEls = [];

/* -------- SET DOOR CONTENT -------- */
function setDoorContent(el, index) {
  const number = doorNumbers[index];
  const album = shuffledAlbums[index];

  // Colour: star + trunk do NOT use the randomiser  
  if (index > 0 && index < POSITIONS_COUNT - trunkHeight) {
    el.style.backgroundColor = doorColors[colorMap[index]];
  }

  if (opened[index]) {
    el.classList.add("opened");
    el.innerHTML = `
      <img class="cover" src="${album.cover}" alt="${album.title} cover">
      <span class="door-number">${number}</span>
    `;
  } else {
    el.classList.remove("opened");
    el.innerHTML = `<span class="door-number">${number}</span>`;
  }
}

/* -------- BUILD TREE -------- */
let positionIndex = 0;

/* Star row (index 0) */
const starRow = document.createElement("div");
starRow.className = "row";

const starDoor = document.createElement("div");
starDoor.className = "day star";
doorEls[positionIndex] = starDoor;
setDoorContent(starDoor, positionIndex);
starRow.appendChild(starDoor);
calendarEl.appendChild(starRow);
positionIndex++;

/* Body rows */
bodyRowStructure.forEach((rowSize) => {
  const row = document.createElement("div");
  row.className = "row";
  for (let i = 0; i < rowSize; i++) {
    const door = document.createElement("div");
    door.className = "day";
    doorEls[positionIndex] = door;
    setDoorContent(door, positionIndex);
    row.appendChild(door);
    positionIndex++;
  }
  calendarEl.appendChild(row);
});

/* Trunk tiles */
for (let t = 0; t < trunkHeight; t++) {
  const door = document.createElement("div");
  door.className = "day";
  doorEls[positionIndex] = door;
  setDoorContent(door, positionIndex);
  trunkEl.appendChild(door);
  positionIndex++;
}

/* -------- DOOR OPEN PERMISSIONS -------- */
function canOpenDoor(index) {
  const number = doorNumbers[index];

  // Admin override always allows opening
  if (adminOverride) return true;

  // Prevent ANY opening before 1 December NZ time
  if (todayNzMonth < 12) return false;

  // Doors unlock sequentially starting Dec 1
  if (todayNzMonth === 12 && number <= todayNzDay) return true;

  // Already-opened doors can be re-opened
  if (opened[index]) return true;

  return false;
}


/* -------- DOOR CLICK HANDLERS -------- */
doorEls.forEach((el, index) => {
  el.addEventListener("click", () => {
    if (!canOpenDoor(index)) {
      el.classList.add("locked-shake");
      setTimeout(() => el.classList.remove("locked-shake"), 300);
      return;
    }

    el.classList.add("opening");
    setTimeout(() => el.classList.remove("opening"), 250);

    openDoor(index);
  });
});

/* -------- MODAL & ICON LOGIC -------- */
const albumModal     = document.getElementById("albumModal");
const albumCoverEl   = document.getElementById("albumCover");
const albumTitleEl   = document.getElementById("albumTitle");
const albumYearEl    = document.getElementById("albumYear");

const spotifyIcon    = document.getElementById("spotifyIcon");
const geniusIcon     = document.getElementById("geniusIcon");
const spotifyMenu    = document.getElementById("spotifyMenu");
const geniusMenu     = document.getElementById("geniusMenu");

const surpriseGiftBtn = document.getElementById("surpriseGiftBtn");

let currentAlbum = null;
let lastOpenedIndex = null;


/* Clear popup menus */
function clearMenus() {
  spotifyMenu.innerHTML = "";
  geniusMenu.innerHTML = "";
  spotifyMenu.classList.remove("open");
  geniusMenu.classList.remove("open");
}

/* Build a popup menu */
function buildMenu(menuEl, items) {
  menuEl.innerHTML = "";
  items.forEach((item) => {
    const btn = document.createElement("button");
    btn.textContent = item.name;
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (item.url) window.open(item.url, "_blank");
      menuEl.classList.remove("open");
    });
    menuEl.appendChild(btn);
  });
}
    
function openDoor(index) {
  opened[index] = true;
  save(KEY_OPENED, opened);

  const album = shuffledAlbums[index];
  currentAlbum = album;
  lastOpenedIndex = index;

  setDoorContent(doorEls[index], index);

  albumCoverEl.src = album.cover;
  albumTitleEl.textContent =
    album.year ? `${album.title} (${album.year})` : album.title;
  albumYearEl.textContent = "";

  clearMenus();

  /* ---- SPOTIFY HANDLING ---- */
  spotifyIcon.classList.remove("disabled");
  spotifyIcon.onclick = null;

  if (album.spotifyMenu) {
    spotifyIcon.onclick = (e) => {
      e.stopPropagation();
      const open = spotifyMenu.classList.contains("open");
      clearMenus();
      if (!open) {
        buildMenu(spotifyMenu, album.spotifyMenu);
        spotifyMenu.classList.add("open");
      }
    };
  } else if (album.spotify) {
    spotifyIcon.onclick = () => window.open(album.spotify, "_blank");
  } else {
    spotifyIcon.classList.add("disabled");
  }

  /* ---- GENIUS HANDLING ---- */
  geniusIcon.classList.remove("disabled");
  geniusIcon.onclick = null;

  if (album.geniusMenu) {
    geniusIcon.onclick = (e) => {
      e.stopPropagation();
      const open = geniusMenu.classList.contains("open");
      clearMenus();
      if (!open) {
        buildMenu(geniusMenu, album.geniusMenu);
        geniusMenu.classList.add("open");
      }
    };
  } else if (album.genius) {
    geniusIcon.onclick = () => window.open(album.genius, "_blank");
  } else {
    geniusIcon.classList.add("disabled");
  }

  albumModal.style.display = "flex";
}

/* -------- CLOSE MODAL -------- */
function closeModal() {
  albumModal.style.display = "none";
  clearMenus();
  currentAlbum = null;
}
window.closeModal = closeModal;

/* Close menus if clicking outside */
document.addEventListener("click", (e) => {
  const withinSpotify = spotifyIcon.contains(e.target) || spotifyMenu.contains(e.target);
  const withinGenius  = geniusIcon.contains(e.target)  || geniusMenu.contains(e.target);
  if (!withinSpotify && !withinGenius) clearMenus();
});

/* -------- SURPRISE GIFT BUTTON -------- */
function updateSurpriseGiftVisibility() {
  const is25th = todayNzDay === 25;
  surpriseGiftBtn.style.display =
    is25th || adminOverride ? "inline-flex" : "none";
}

surpriseGiftBtn.addEventListener("click", () => {
  window.open(
    "https://m.youtube.com/watch?v=Ovi1SKwfyxU&pp=ygUWeG1hcyBoYXMgYmVlbiB4ZWQgbm9meA%3D%3D",
    "_blank"
  );
});

updateSurpriseGiftVisibility();

/* -------- ADMIN OVERRIDE (Shift + O) -------- */
document.addEventListener("keydown", (e) => {
  if (e.key === "O" && e.shiftKey) {
    const code = prompt("Enter override code:");
    if (code === "fatmike") {
      adminOverride = true;
      save(KEY_OVERRIDE, true);
      alert("Admin override enabled");
      updateSurpriseGiftVisibility();
    }
  }
});

/* -------- SNOW EFFECT -------- */
function spawnSnowflake() {
  const s = document.createElement("div");
  s.className = "snowflake";
  s.textContent = "‚ùÑ";
  s.style.left = Math.random() * window.innerWidth + "px";
  s.style.fontSize = 10 + Math.random() * 16 + "px";
  s.style.animationDuration = 5 + Math.random() * 5 + "s";
  s.style.opacity = 0.4 + Math.random() * 0.6;
  document.body.appendChild(s);
  setTimeout(() => s.remove(), 11000);
}

setInterval(spawnSnowflake, 220);
async function createShareCard(album, dayNumber) {
  return new Promise((resolve) => {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    // Card size (IG-friendly)
    canvas.width = 1080;
    canvas.height = 1920;

    // Background color (matches your card)
    ctx.fillStyle = "#5f6f34"; // your green tone
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Load album cover
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = album.cover;

    img.onload = () => {
      // Draw album cover
      const imgSize = 900;
      const imgX = (canvas.width - imgSize) / 2;
      const imgY = 300;

      ctx.drawImage(img, imgX, imgY, imgSize, imgSize);

      // Title: "My album for Day X"
      ctx.fillStyle = "white";
      ctx.font = "bold 70px Arial";
      ctx.textAlign = "center";
      ctx.fillText(`My album for Day ${dayNumber}`, canvas.width / 2, 180);

      // Album Title
      ctx.font = "bold 80px Arial";
      ctx.fillText(album.title, canvas.width / 2, imgY + imgSize + 140);

      // Artist (NOFX)
      ctx.font = "50px Arial";
      ctx.fillText("NOFX", canvas.width / 2, imgY + imgSize + 220);

      // Footer "NOFX Days of Christmas"
      ctx.font = "bold 55px Arial";
      ctx.fillText("NOFX Days of Christmas", canvas.width / 2, canvas.height - 140);

      resolve(canvas.toDataURL("image/png"));
    };
  });
}
const shareIcon = document.getElementById("shareIcon");

shareIcon.addEventListener("click", async () => {
  if (!currentAlbum || lastOpenedIndex === null) {
    alert("Open a door first!");
    return;
  }

  const dayNumber = doorNumbers[lastOpenedIndex];

  // Build the share card
  const imageData = await createShareCard(currentAlbum, dayNumber);

  // Mobile share sheet
  if (navigator.share) {
    const response = await fetch(imageData);
    const blob = await response.blob();
    const file = new File([blob], "nofx-share.png", { type: "image/png" });

    try {
      await navigator.share({
        files: [file],
        title: "NOFX Days of Christmas",
        text: `My album for Day ${dayNumber}!`,
      });
      return;
    } catch (err) {
      console.log("Share canceled");
    }
  }

  // Desktop fallback: download image
  const a = document.createElement("a");
  a.href = imageData;
  a.download = `day-${dayNumber}-nofx.png`;
  a.click();
});

    </script>
