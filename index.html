<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOFX Days of Christmas</title>
<style>
  body {
    font-family: 'Comic Sans MS', Arial, sans-serif;
    background: linear-gradient(to bottom, #ffefef, #fff5f0);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    overflow-x: hidden;
    position: relative;
  }

  .wrapper {
    text-align: center;
  }

  h1 {
    color: #d70000;
    text-shadow: 2px 2px #fff;
    font-size: 2.2em;
    margin-bottom: 10px;
  }

  .calendar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    z-index: 2;
    position: relative;
  }

  .row {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .trunk {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
  }

  .day {
    background: #ffdddd;
    border-radius: 15px;
    padding: 15px;
    min-width: 55px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: transform 0.2s, background 0.2s;
    font-weight: bold;
    font-size: 0.9em;
  }

  .day:hover {
    transform: scale(1.05);
    background: #ffe0e0;
  }

  .day.opened {
    background: #a0ffa0;
  }

  .day.star {
    background: #ffe8a0;
    border: 2px solid #ffcc00;
    box-shadow: 0 4px 10px rgba(255, 204, 0, 0.5);
  }

  #albumModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3;
    padding: 20px;
    box-sizing: border-box;
  }

  #albumContent {
    background: #fff0f0;
    padding: 20px;
    border-radius: 15px;
    width: 100%;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    border: 2px solid #d70000;
  }

  button {
    margin-top: 15px;
    padding: 10px 20px;
    border: none;
    background: #d70000;
    color: #fff;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }

  button:hover {
    background: #ff1a1a;
  }

  .snowflake {
    position: fixed;
    top: -10px;
    color: #fff;
    font-size: 1em;
    user-select: none;
    pointer-events: none;
    z-index: 1;
    animation-name: fall;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
  }

  @keyframes fall {
    0%   { transform: translateY(0) rotate(0deg); }
    100% { transform: translateY(100vh) rotate(360deg); }
  }
</style>
</head>
<body>
<div class="wrapper">
  <h1>NOFX Days of Christmas</h1>

  <div class="calendar" id="calendar"></div>

  <div class="trunk" id="trunk"></div>
</div>

<div id="albumModal">
  <div id="albumContent">
    <h2 id="albumTitle"></h2>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
  // 23 albums to match 23 doors in this tree shape
  const albums = [
    "Liberal Animation",
    "S&M Airlines",
    "Ribbed",
    "White Trash, Two Heebs and a Bean",
    "Punk in Drublic",
    "Heavy Petting Zoo",
    "So Long and Thanks for All the Shoes",
    "Pump Up the Valuum",
    "The War on Errorism",
    "Wolves in Wolves’ Clothing",
    "Coaster",
    "Self Entitled",
    "First Ditch Effort",
    "Single Album",
    "Double Album",
    "Half Album",
    "Maximum RocknRoll",
    "45 or 46 Songs That Weren’t Good Enough to Go on Our Other Records",
    "The Longest EP",
    "Backstage Passport Soundtrack",
    "I Heard They Suck Live!!",
    "They’ve Actually Gotten Worse Live!",
    "The Decline"
  ];

  // Tree body like your picture: 1,2,3,4,5,6 = 21 tiles
  const bodyRowStructure = [1, 2, 3, 4, 5, 6];
  // Trunk: 2 tiles stacked = 2, total 23
  const trunkHeight = 2;

  const POSITIONS_COUNT =
    bodyRowStructure.reduce((a, b) => a + b, 0) + trunkHeight; // 23

  const STORAGE_PREFIX = "nofx_tree_star_v2_";
  const KEY_ALBUMS = STORAGE_PREFIX + "albums";
  const KEY_DOOR_NUMBERS = STORAGE_PREFIX + "door_numbers";
  const KEY_OPENED = STORAGE_PREFIX + "opened_positions";

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function loadJSON(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch {
      return fallback;
    }
  }

  function saveJSON(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
  }

  // ----- PER-VISITOR STATE -----

  // 1) Shuffled albums per position (0..22)
  let shuffledAlbums = loadJSON(KEY_ALBUMS, null);
  if (!shuffledAlbums || shuffledAlbums.length !== albums.length) {
    shuffledAlbums = shuffleArray([...albums]);
    saveJSON(KEY_ALBUMS, shuffledAlbums);
  }

  // 2) Door numbers per position (0..22)
  //    position 0 is ALWAYS 24 (star)
  //    positions 1..22 are random from 1..23
  let doorNumbers = loadJSON(KEY_DOOR_NUMBERS, null);
  if (!doorNumbers || doorNumbers.length !== POSITIONS_COUNT || doorNumbers[0] !== 24) {
    const pool = shuffleArray(Array.from({ length: 23 }, (_, i) => i + 1)); // 1..23
    doorNumbers = [24, ...pool.slice(0, POSITIONS_COUNT - 1)];
    saveJSON(KEY_DOOR_NUMBERS, doorNumbers);
  }

  // 3) Opened positions (by index 0..22)
  let openedPositions = loadJSON(KEY_OPENED, {});

  const calendarEl = document.getElementById("calendar");
  const trunkEl = document.getElementById("trunk");
  const doorElements = []; // index -> DOM element

  // Optional: date-based locking (off for now)
  const today = 24; // or new Date().getDate() in December

  // Helper to set the door label (number vs number + album)
  function setDoorLabel(el, positionIndex) {
    const number = doorNumbers[positionIndex];
    const albumName = shuffledAlbums[positionIndex];

    if (openedPositions[positionIndex]) {
      el.innerText = number + " - " + albumName;
    } else {
      el.innerText = number;
    }
  }

  // ----- BUILD TREE BODY (including star at top) -----
  let positionIndex = 0;

  bodyRowStructure.forEach(rowSize => {
    const row = document.createElement("div");
    row.className = "row";

    for (let i = 0; i < rowSize; i++) {
      const door = document.createElement("div");
      door.className = "day";

      setDoorLabel(door, positionIndex);

      // Make the very first tile the star (24)
      if (positionIndex === 0) {
        door.classList.add("star");
      }

      if (openedPositions[positionIndex]) {
        door.classList.add("opened");
      }

      const idx = positionIndex;
      door.onclick = () => openDoor(idx);

      row.appendChild(door);
      doorElements[idx] = door;
      positionIndex++;
    }

    calendarEl.appendChild(row);
  });

  // ----- BUILD TRUNK (2 tiles stacked) -----
  for (let t = 0; t < trunkHeight; t++) {
    const door = document.createElement("div");
    door.className = "day";

    setDoorLabel(door, positionIndex);

    if (openedPositions[positionIndex]) {
      door.classList.add("opened");
    }

    const idx = positionIndex;
    door.onclick = () => openDoor(idx);

    trunkEl.appendChild(door);
    doorElements[idx] = door;
    positionIndex++;
  }

  // ----- DOOR LOGIC -----
  function openDoor(positionIndex) {
    const album = shuffledAlbums[positionIndex];
    document.getElementById("albumTitle").innerText = album;
    document.getElementById("albumModal").style.display = "flex";

    openedPositions[positionIndex] = true;
    saveJSON(KEY_OPENED, openedPositions);

    const door = doorElements[positionIndex];
    if (door) {
      door.classList.add("opened");
      setDoorLabel(door, positionIndex);
    }
  }

  function closeModal() {
    document.getElementById("albumModal").style.display = "none";
  }
  window.closeModal = closeModal;

  // ----- SNOW EFFECT -----
  function createSnowflake() {
    const snowflake = document.createElement("div");
    snowflake.className = "snowflake";
    snowflake.style.left = Math.random() * window.innerWidth + "px";
    snowflake.style.fontSize = Math.random() * 20 + 10 + "px";
    snowflake.style.animationDuration = Math.random() * 5 + 5 + "s";
    snowflake.style.opacity = Math.random();
    snowflake.textContent = "❄";
    document.body.appendChild(snowflake);
    setTimeout(() => snowflake.remove(), 10000);
  }

  setInterval(createSnowflake, 200);
</script>
</body>
</html>
